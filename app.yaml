appname: "eru"
entrypoints:
  agent:
    cmd: "/usr/bin/eru-agent --config /agent.yaml"
    restart: always
    publish:
      - "12345"
    healthcheck:
      tcp_ports:
        - "12345"
    privileged: true
volumes:
  - /sys:/sys:ro
  - /var/run/docker.sock:/var/run/docker.sock
  - /proc/:/hostProc/
stages:
  - build
  - pack
builds:
  build:
    base: "golang:1.10.3-alpine3.8"
    # only support ssh protocol
    repo: "git@github.com:projecteru2/agent.git"
    version: "HEAD"
    dir: /go/src/github.com/projecteru2/agent
    commands:
      - apk add --no-cache git curl make
      - curl https://glide.sh/get | sh
      - make test
      - make binary
      - ./eru-agent --version
    cache:
      /go/src/github.com/projecteru2/agent/eru-agent: /usr/bin/eru-agent
  pack:
    base: alpine:3.8
    labels:
      ERU: 1
      version: latest
      agent: 1
    envs:
      AGENT_IN_DOCKER: 1
    commands:
      - mkdir -p /etc/eru/
